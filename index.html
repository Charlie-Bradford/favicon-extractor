<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favicon Extractor</title>
    <style>
      #favicon-container {
        margin-top: 20px;
        display: flex;
        justify-content: center; /* Center the content */
        align-items: center; /* Vertically center the content */
        min-height: 100vh; /* Ensure full viewport height */
        background-color: #ffffff; /* Default background color: white */
      }
      img {
        max-width: 100px;
        max-height: 100px;
        border-radius: 4px;
      }
      body {
        margin: 0; /* Remove default body margin */
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
    <div id="favicon-container"></div>

    <script>
    /**
     * Asynchronously fetches an image from a URL, with CORS handling.
     *
     * @param {string} url - The URL to fetch.
     * @returns {Promise<HTMLImageElement|null>} - A Promise that resolves to an Image object or null on error.
     */
    async function fetchImage(url) {
        try {
            //Remove mode: 'cors',
            const response = await fetch(url);
            if (!response.ok) {
                return null;
            }
            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);
            const img = $("<img>");
            img.attr("src", imageUrl);

            await new Promise((resolve, reject) => {
                img.on('load', resolve);
                img.on('error', reject);
            });
            return img[0]; // Return the underlying HTMLImageElement

        } catch (error) {
            console.error('Error fetching image:', error);
            return null;
        }
    }



    /**
     * Generates an SVG data URL for the first letter of the domain.
     * @param {string} domain - The domain name.
     * @param {number} size - The size of the SVG.
     * @param {string} bgcolor - The background color of the SVG.
     * @param {string} textcolor - The text color of the SVG.
     * @returns {string} - A data URL containing the SVG.
     */
    function generateFallbackSVG(domain, size = 64, bgcolor = '#ffffff', textcolor = '#000000') {
        const firstLetter = domain.charAt(0).toUpperCase();
        const fontSize = size * 0.7;
        const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="${size}" height="${size}">
            <style>
                .letter {
                    font-size: ${fontSize}px;
                    font-family: sans-serif;
                    fill: ${textcolor};
                }
                .bg {
                    fill: ${bgcolor};
                }
            </style>
            <rect class="bg" width="100" height="100" rx="10" fill="${bgcolor}"/>
            <text class="letter" x="50" y="55" dominant-baseline="middle" text-anchor="middle" fill="${textcolor}">${firstLetter}</text>
        </svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(svgContent)}`;
    }


    window.onload = async function() {
        const container = $('#favicon-container');
        container.html(''); // Clear container

        // Get the query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const domain = urlParams.get('domain');
        const fallbackUrl = urlParams.get('fallback');
        let bgcolor = urlParams.get('bgcolor');
        let textcolor = urlParams.get('textcolor');

        // Set default colors, and only override if query parameters are provided.
        const defaultBgColor = '#ffffff';  // White
        const defaultTextColor = '#000000'; // Black

        if (!bgcolor) {
            bgcolor = defaultBgColor;
        }
        if (!textcolor) {
            textcolor = defaultTextColor;
        }


        if (!domain) {
            return; // Don't do anything if there's no domain
        }

        // 1. Try to get the image from the provided URL
        let faviconUrl = `https://www.google.com/s2/favicons?domain=${domain}.ico`;
        const fetchedImage = await fetchImage(faviconUrl);
        if (fetchedImage) {
            container.append(fetchedImage);
            return; // If we get the image, we're done.
        }

        // 2. If no image, try to use the fallback URL
        let fallbackImage = null;
        if (fallbackUrl) {
            fallbackImage = await fetchImage(fallbackUrl); // Use fetchImage
        }

        // 3. If no favicon image, and we have a valid fallback image, use that.
        if (fallbackImage) {
            container.append(fallbackImage);
            return;
        }

        // 4. If no favicon and no/invalid fallback, generate the SVG
        const svgDataUrl = generateFallbackSVG(domain, 64, bgcolor, textcolor);
        const svgImg = $("<img>").attr("src", svgDataUrl);
        container.append(svgImg);
    };
    </script>
</body>
</html>
