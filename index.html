<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favicon Extractor</title>
    <style>
      #favicon-container {
        margin-top: 20px;
        display: flex;
        justify-content: center; /* Center the content */
        align-items: center; /* Vertically center the content */
        min-height: 100vh; /* Ensure full viewport height */
        background-color: #ffffff; /* Default background color: white */
      }
      img {
        max-width: 100px;
        max-height: 100px;
        border-radius: 4px;
      }
      body {
        margin: 0; /* Remove default body margin */
      }
    </style>
</head>
<body>
    <div id="favicon-container"></div>

    <script>
    /**
     * Asynchronously fetches a favicon from Google's favicon service.
     *
     * @param {string} domain - The domain name (e.g., "example.com").
     * @returns {Promise<HTMLImageElement|null>} - A Promise that resolves to an Image object
     * or null on error.
     */
    async function getFaviconWithGoogle(domain) {
        try {
            // Construct the Google favicon service URL
            const faviconUrl = `https://icons.duckduckgo.com/ip3/${domain}.ico`;

            // Fetch the favicon
            const response = await fetch(faviconUrl);
            if (!response.ok) {
                return null; // Return null on error, don't throw
            }
            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);

            const img = new Image();
            img.src = imageUrl;

            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
            });

            return img;

        } catch (error) {
            console.error(`Error fetching favicon for ${domain}:`, error);
            return null; // Return null on fetch error
        }
    }


    /**
     * Generates an SVG data URL for the first letter of the domain.
     * @param {string} domain - The domain name.
     * @param {number} size - The size of the SVG.
     * @param {string} bgcolor - The background color of the SVG.
     * @param {string} textcolor - The text color of the SVG.
     * @returns {string} - A data URL containing the SVG.
     */
    function generateFallbackSVG(domain, size = 64, bgcolor = '#ffffff', textcolor = '#000000') {
        const firstLetter = domain.charAt(0).toUpperCase();
        const fontSize = size * 0.7;
        const svgContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="${size}" height="${size}">
            <style>
                .letter {
                    font-size: ${fontSize}px;
                    font-family: sans-serif;
                    fill: ${textcolor};
                }
                .bg {
                    fill: ${bgcolor};
                }
            </style>
            <rect class="bg" width="100" height="100" rx="10" fill="${bgcolor}"/>
            <text class="letter" x="50" y="55" dominant-baseline="middle" text-anchor="middle" fill="${textcolor}">${firstLetter}</text>
        </svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(svgContent)}`;
    }


    window.onload = async function() {
        const container = document.getElementById('favicon-container');
        container.innerHTML = ''; // Clear container

        // Get the query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const domain = urlParams.get('domain');
        const fallbackUrl = urlParams.get('fallback');
        let bgcolor = urlParams.get('bgcolor');
        let textcolor = urlParams.get('textcolor');

        // Set default colors, and only override if query parameters are provided.
        const defaultBgColor = '#ffffff';  // White
        const defaultTextColor = '#000000'; // Black

        if (!bgcolor) {
            bgcolor = defaultBgColor;
        }
        if (!textcolor) {
            textcolor = defaultTextColor;
        }


        if (!domain) {
            return; // Don't do anything if there's no domain
        }

        // 1. Try to get the favicon
        const favicon = await getFaviconWithGoogle(domain);
        if (favicon) {
            container.appendChild(favicon);
            return; // If we get the favicon, we're done.
        }

        // 2. If no favicon, try to use the fallback URL
        if (fallbackUrl) {
            try {
                const fallbackImage = await loadImage(fallbackUrl);
                container.appendChild(fallbackImage);
                return; // If we get the fallback image, we're done.
            } catch (e) {
                console.error("Error loading fallback image:", e);
                // If the fallback image fails to load, we fall through to the SVG
            }
        }

        // 3. If no favicon and no/invalid fallback, generate the SVG
        const svgDataUrl = generateFallbackSVG(domain, 64, bgcolor, textcolor);
        const svgImg = new Image();
        svgImg.src = svgDataUrl;
        container.appendChild(svgImg);
    };

    /**
     * Loads an image from a given URL and returns a Promise.
     * @param {string} url
     * @returns {Promise<HTMLImageElement>}
     */
    function loadImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = url;
            img.onload = () => resolve(img);
            img.onerror = (err) => {
                console.error("Error loading image:", url, err);
                reject(err); // Reject the promise on error
            };
        });
    }
    </script>
</body>
</html>
