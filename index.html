import requests
from io import BytesIO
from PIL import Image, ImageChops
import imagehash  # For perceptual hashing (optional, but recommended)
import hashlib

def get_favicon_with_duckduckgo(domain, fallback_path="fallback.png"):
    """
    Fetches a favicon from DuckDuckGo's favicon service, replacing a specific
    error image with a fallback.

    Args:
        domain (str): The domain name (e.g., "example.com").
        fallback_path (str): Path to the fallback image.

    Returns:
        Image.Image: The favicon or the fallback image as a PIL Image object.
                      Returns None on critical error.
    """
    try:
        # Construct the DuckDuckGo favicon service URL
        favicon_url = f"https://icons.duckduckgo.com/ip3/{domain}"
        response = requests.get(favicon_url, stream=True, timeout=5)
        response.raise_for_status()

        favicon_image = Image.open(BytesIO(response.content))

        # Check for the specific error image
        if is_error_image(favicon_image):
            print(f"Detected error favicon for {domain}, using fallback.")
            return Image.open(fallback_path)
        return favicon_image

    except (requests.exceptions.RequestException, IOError) as e:
        print(f"Error fetching favicon for {domain}: {e}, using fallback.")
        return Image.open(fallback_path)
    except Exception as e:
        print(f"Critical error processing favicon for {domain}: {e}")
        return None



def is_error_image(img):
    """
    Compares the given image against the known error image.

    Args:
        img (Image.Image): The image to compare.

    Returns:
        bool: True if the image is the error image, False otherwise.
    """
    # Load your specific error image
    error_img = Image.open("error_favicon.png")

    # Resize images to a common size
    img = img.resize(error_img.size)

    # Calculate perceptual hash
    img_hash = imagehash.average_hash(img)
    error_hash = imagehash.average_hash(error_img)

    # Compare the hashes
    if img_hash - error_hash < 5:
        return True
    return False



if __name__ == "__main__":
    test_domains = [
        "example.com",
        "google.com",
        "invalid-domain.com",  # Test with a domain that might not have a clear favicon
    ]

    for domain in test_domains:
        favicon = get_favicon_with_duckduckgo(domain)
        if favicon:
            print(f"Successfully retrieved favicon for {domain}")
            favicon.show()
        else:
            print(f"Failed to get favicon for {domain}")
